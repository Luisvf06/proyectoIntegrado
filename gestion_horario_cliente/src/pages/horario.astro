---
// src/pages/horario.astro
import Navbar from '../components/navbar.astro';
import Layout from '../layouts/Layout.astro';

let user = { name: 'Cargando...', email: '...', id: null, professor_cod: '...' };
let error = null;
---

<Layout title="Inicio">
  <Navbar />
  <div id="error" class="error-message">{error}</div>
  <div class="user-info">
    <h1 id="username">{user.name}</h1>
    <p><strong>Name:</strong> <span id="username">{user.name}</span></p>
    <p><strong>Email:</strong> <span id="user-email">{user.email}</span></p>
    <p><strong>ID:</strong> <span id="user-id">{user.id}</span></p>
    <p><strong>Professor Code:</strong> <span id="user-professor-cod">{user.professor_cod}</span></p>
  </div>
  <script type="module">
    async function fetchUserData() {
      const token = sessionStorage.getItem('authToken');
      if (!token) {
        document.getElementById('error').textContent = 'User is not authenticated';
        return;
      }

      try {
        const dataUser = await fetch('http://127.0.0.1:8080/api/user', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });

        if (!dataUser.ok) {
          throw new Error('Failed to fetch user data');
        }

        const userData = await dataUser.json();
        updateDOM(userData, null);
      } catch (err) {
        updateDOM(null, err.message);
      }
    }

    function updateDOM(user, error) {
      if (error) {
        document.getElementById('error').textContent = error;
      } else {
        document.getElementById('username').textContent = user.name;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-id').textContent = user.id;
        document.getElementById('user-professor-cod').textContent = user.professor_cod;
      }
    }

    fetchUserData();
  </script>
</Layout>
